var nid=1;OT2.Tree=function(e,i){OT2.Event.call(this),this.showCheckbox=i||!1,this.datatype="CategoryTree",this.$box=e||$("<div>"),this.$el=$('<div class="t2-tree"></div>'),this.$box.empty(),this.$box.append(this.$el),this.$list=this.$el.find("ul.t2bd"),this.childNodes=[],this.nodeList=[]},OT2.Tree.prototype={url:"",queryParmas:null,fetch:function(e,i,t,s){this.url=e,this.queryParmas=i;var h=this;return h.removeAll(),"undefined"!=typeof t?(h.render(t),h.listen(),!1):void $.getJSON(e,i,function(e){h.render(e),h.listen(),"function"==typeof s&&s.call(h,e)})},render:function(e){if(!e||0==e.length){var i=$.trim(this.$el.parents(".chapter-con").find("h1").text()),t=i.substring(2),s=t.indexOf("章节")>-1?t+"同步":t;return this.$el.parents("#select-form").length>0?this.$el.parents("#select-form").html('<div class="null-page" style="width:100%;text-align: center;color:#333;font-size: 14px;margin: 200px auto;"><img src="/images/blank.png"/><p style="padding-top:10px;font-size: 16px; color: #666; font-family:Microsoft YaHei">当前学科下暂不支持'+s+"选题!</p></div>"):this.$el.append('<p class="t2blank">暂无相关数据...</p>'),!1}var h=OT2.renderTreeList(this,e);this.childNodes=h.treeNodes,this.$el.append(h.$el),this.showCheckbox&&this.initCheckbox()},initCheckbox:function(){_.each(this.childNodes,function(e){e.checkbox.switchChecked(!1)})},listen:function(){this.subscribe("Node:build:relation",function(e){return 0!=e.childNodes.length&&void _.each(e.childNodes,function(i){i.parent=e})})},getNodeListChecked:function(){if(!this.showCheckbox)return[];var e=[];return _.each(this.nodeList,function(i){i.checkbox.checked&&e.push(i)}),e},removeAll:function(){this.childNodes=[],this.nodeList=[],this.$el.html("")}},_.extend(OT2.Tree.prototype,OT2.Event.prototype),OT2.compileTreeNodeTemplate=function(){var e='<li <% if (!hasChild) { %> class="t2end" <% } %> data-treeid="<%= id %>" >\t<div class="t2hd">\t\t<span></span>\t\t<a href="javascript:;">\t\t\t<% if (showCheckbox) { %><b class="checkbox"><input type="checkbox" name="" value=""></b><% } %>\t\t\t<em><%= title %></em>\t\t</a>\t</div></li>';return _.template(e)},OT2.renderTreeList=function(e,i){for(var t,s=$('<ul class="t2bd"></ul>'),h=[],n=0;t=i[n++];){var o=new OT2.Tree.Node(e,t);h.push(o),e.nodeList.push(o),s.append(o.$el)}return{$el:s,treeNodes:h}},OT2.Tree.Node=function(e,i){this.nid=nid++,this.tree=e,this.model=i,this.model.showCheckbox=this.tree.showCheckbox,this.parent=null,this.childNodes=[],this.$el=null,this.$icon=null,this.$bd=null,this.$tit=null,this.isChildLoaded=!1,this.isChildVisible=!1,this.init()},OT2.Tree.Node.prototype={init:function(){this.render(),this.bindEvent(),this.model.showCheckbox&&this.initCheckbox()},render:function(){var e=OT2.compileTreeNodeTemplate()(this.model);this.$el=$(e),this.$icon=this.$el.find("span"),this.$tit=this.$el.find("a")},bindEvent:function(){var e=this;this.$icon.on("click",function(){if(e.isChildLoaded)return e.switchVisible(),!1;var i=e.tree.queryParmas;i.id=e.model.id;var t=$('<div class="tloading"><img src="/images/tloading.gif"></div>').hide().appendTo(e.$el),s=setTimeout(function(){t.show()},500);$.getJSON(e.tree.url,i).done(function(i){if(s&&clearTimeout(s),t.remove(),i.length<=0)return!1;e.isChildLoaded=!0,e.isChildVisible=!0,e.$el.addClass("t2on");var h=OT2.renderTreeList(e.tree,i);e.childNodes=h.treeNodes,e.tree.publish("Node:build:relation",e),e.model.showCheckbox&&_.each(e.childNodes,function(i){i.checkbox.switchChecked(e.checkbox.checked)}),e.$el.append(h.$el)})}),this.$tit.on("click",function(){e.tree.publish("Node:select",e)})},switchVisible:function(){this.isChildVisible=!this.isChildVisible,this.$el[this.isChildVisible?"addClass":"removeClass"]("t2on")},initCheckbox:function(){var e=this;this.checkbox=new OT2.Element.checkbox(this.$tit),this.checkbox.bindEvent(function(){e.model.hasChild&&e.tree.publish("Node:checkNext",e),e.tree.publish("Node:checkPrev",e),e.tree.publish("Node:checked",e)}),e.tree.subscribe("Node:checkNext",function(i){_.contains(i.childNodes,e)&&(e.checkbox.switchChecked(i.checkbox.checked),e.childNodes.length>0&&e.tree.publish("Node:checkNext",e))}),e.tree.subscribe("Node:checkPrev",function(i){if(_.contains(e.childNodes,i)){var t=!0;_.each(e.childNodes,function(e){e.checkbox.checked||(t=!1)}),e.checkbox.switchChecked(t),e.tree.publish("Node:checkPrev",e)}})}};